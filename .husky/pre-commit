#!/bin/sh

# Husky pre-commit hook - Run formatting, linting, and unit tests

# Set HUSKY env var to reduce verbosity
export HUSKY=1

echo "🔍 Running pre-commit checks..."

# Validate package consistency first
echo "📦 Validating package consistency..."
pnpm exec tsx scripts/validate-packages.ts

if [ $? -ne 0 ]; then
  echo "❌ Package validation failed! Fix consistency issues before committing."
  echo "💡 See Package Creation Guide: docs/development/PACKAGE_CREATION_GUIDE.md"
  exit 1
fi

# Run lint-staged to format and lint only staged files
echo "📝 Checking code style..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "❌ Lint-staged checks failed! Fix issues before committing."
  exit 1
fi

echo "🧪 Running unit tests..."

# Run unit tests for all packages (using turbo for caching)
# Use 'new-only' to show output only for non-cached tasks
# Vitest will handle timing and reporting internally
pnpm turbo run test --ui stream --output-logs=new-only --log-order=grouped

if [ $? -ne 0 ]; then
  echo "❌ Unit tests failed!"
  echo "💡 Fix failing tests before committing"
  exit 1
fi

echo "✅ All pre-commit checks passed!"