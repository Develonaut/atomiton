#!/bin/sh

# Husky pre-commit hook - Run formatting, linting, and smoke tests

echo "ğŸ” Running pre-commit checks..."

# Validate package consistency first
echo "ğŸ“¦ Validating package consistency..."
pnpm exec tsx scripts/validate-packages.ts

if [ $? -ne 0 ]; then
  echo "âŒ Package validation failed! Fix consistency issues before committing."
  echo "ğŸ’¡ See Package Creation Guide: docs/development/PACKAGE_CREATION_GUIDE.md"
  exit 1
fi

# Run lint-staged to format and lint only staged files
echo "ğŸ“ Checking code style..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "âŒ Lint-staged checks failed! Fix issues before committing."
  exit 1
fi

echo "ğŸ”¥ Running smoke tests (must complete in <5 seconds)..."

# Run smoke tests with proper timing
START_TIME=$(date +%s)

# Run smoke tests for all packages (using turbo for caching)
# Note: test:smoke script must exist in all packages per our standards
pnpm test:smoke

SMOKE_EXIT_CODE=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Check if tests failed
if [ $SMOKE_EXIT_CODE -ne 0 ]; then
  echo "âŒ Smoke tests failed!"
  echo "ğŸ’¡ Fix failing tests before committing"
  echo "ğŸ“Š Run 'pnpm test:dashboard' to see test status"
  exit 1
fi

# Check if tests ran too long (>5 seconds is our hard limit)
if [ $DURATION -gt 5 ]; then
  echo "âŒ Smoke tests took ${DURATION}s (limit: 5s)"
  echo "ğŸ’¡ Move slow tests to integration suite or optimize them"
  echo "ğŸ“Š Run 'pnpm test:dashboard' to identify slow tests"

  # Use TypeScript speed checker if available for detailed analysis
  if [ -f "scripts/test-speed-check.ts" ]; then
    echo ""
    echo "ğŸ” Detailed speed analysis:"
    tsx scripts/test-speed-check.ts test-results/speed-report.json smoke 2>/dev/null || true
  fi

  exit 1
fi

echo "âœ… All pre-commit checks passed! (smoke tests: ${DURATION}s)"