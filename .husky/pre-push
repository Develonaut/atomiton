#!/bin/sh

# Husky pre-push hook - Unit tests, integration tests, benchmarks, and E2E tests

# Set env var to indicate running in git hooks (affects headless mode, dev tools, etc.)
export GIT_HOOKS=1

echo "ðŸ“¤ Pre-push validation..."

# Get the remote we're pushing to (usually origin)
REMOTE="${1:-origin}"
URL="$2"

# Check for benchmark regressions first (fast feedback)
echo "ðŸ“Š Checking for performance regressions..."
pnpm test:benchmark || {
  echo "âŒ Benchmark tests failed!"
  echo "ðŸ’¡ Performance contracts must pass before pushing"
  exit 1
}

# Start dev environment for integration tests
echo "ðŸš€ Starting dev environment for integration tests..."
pnpm dev &
DEV_PID=$!

echo "   â³ Waiting for dev environment to be ready..."
npx wait-on http://localhost:5173 --timeout 60000
sleep 3  # Brief pause for desktop to start after client

# Run integration tests (includes critical user journeys)
echo "ðŸŽ­ Running integration tests (critical paths)..."
echo "   ðŸ”— Running all integration tests from root..."
pnpm test:integration || {
  echo "âŒ Integration tests failed!"
  echo "ðŸ’¡ Critical user journeys must pass before pushing"
  echo "ðŸš¨ Integration test failures are BLOCKING - fix before push"
  kill $DEV_PID 2>/dev/null || true
  exit 1
}

echo "   ðŸ§¹ Cleaning up dev environment..."
kill $DEV_PID 2>/dev/null || true
pnpm kill && pnpm kill:electron

echo ""
echo "âœ… Pre-push checks complete - ready to push!"