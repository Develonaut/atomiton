#!/bin/sh

# Husky pre-push hook - Performance warnings and critical tests

# Set HUSKY env var to reduce verbosity and trigger headless mode
export HUSKY=1

echo "ğŸ“¤ Pre-push validation..."

# Get the remote we're pushing to (usually origin)
REMOTE="${1:-origin}"
URL="$2"

# Run smoke tests first (fast validation) - only for changed packages
echo "ğŸ”¥ Running smoke tests..."
echo "   ğŸ“¦ Testing changed packages in parallel..."
# Use Turbo's filter to only test packages with changes
pnpm turbo run test:smoke --filter="...[origin/main]" --ui stream --output-logs=new-only --log-order=grouped || {
  echo "âŒ Smoke tests failed!"
  echo "ğŸ’¡ Fix smoke tests before pushing"
  exit 1
}

# Check for benchmark regressions
echo "ğŸ“Š Checking for performance regressions..."

# Run benchmarks for changed packages using turbo's built-in change detection
echo "ğŸ“Š Running benchmarks for changed packages..."
# Turbo will automatically detect changed packages and skip unchanged ones
pnpm turbo run test:benchmark --filter="...[origin/main]" --ui stream --output-logs=new-only --log-order=grouped 2>&1 || {
  echo "âŒ Benchmark tests failed!"
  echo "ğŸ’¡ Performance contracts must pass before pushing"
  exit 1
}

# Run critical E2E tests if client app changed
echo "ğŸ­ Checking for E2E tests..."
# Use turbo to detect if client app changed and run E2E tests
pnpm turbo run test:e2e --filter="@atomiton/client...[origin/main]" --ui stream --output-logs=new-only 2>&1 || {
  echo "âš ï¸ Some E2E tests failed (non-blocking)"
  echo "ğŸ’¡ Consider fixing before push"
}

echo ""
echo "âœ… Pre-push checks complete - ready to push!"