#!/bin/sh

# Husky pre-push hook - Unit tests, integration tests, benchmarks, and E2E tests

# Set HUSKY env var to reduce verbosity and trigger headless mode
export HUSKY=1

echo "ğŸ“¤ Pre-push validation..."

# Get the remote we're pushing to (usually origin)
REMOTE="${1:-origin}"
URL="$2"

# Run ALL unit tests - comprehensive final validation before push
echo "ğŸ§ª Running ALL unit tests..."
echo "   ğŸ“¦ Testing all packages - final guard before push..."
# Run all unit tests without filtering - this is our final safety check
pnpm turbo run test --ui stream --output-logs=new-only --log-order=grouped || {
  echo "âŒ Unit tests failed!"
  echo "ğŸ’¡ Fix unit tests before pushing"
  exit 1
}

# Run integration tests
echo "ğŸ”— Running integration tests..."
pnpm test:integration || {
  echo "âŒ Integration tests failed!"
  echo "ğŸ’¡ Fix integration tests before pushing"
  exit 1
}

# Check for benchmark regressions
echo "ğŸ“Š Checking for performance regressions..."
pnpm test:benchmark || {
  echo "âŒ Benchmark tests failed!"
  echo "ğŸ’¡ Performance contracts must pass before pushing"
  exit 1
}

# Run critical user journey tests using Playwright (apps only)
echo "ğŸ­ Running user journey tests (critical paths)..."
# Run Playwright tests for apps that have them - these are blocking and mandatory
echo "   ğŸ“± Running client user journey tests..."
cd apps/client && pnpm playwright test --config playwright.config.ts || {
  echo "âŒ Client user journey tests failed!"
  echo "ğŸ’¡ Critical user journeys must pass before pushing"
  echo "ğŸš¨ User journey test failures are BLOCKING - fix before push"
  exit 1
}
cd ../..

echo "   ğŸ–¥ï¸  Running desktop user journey tests..."
cd apps/desktop && pnpm playwright test --config playwright.config.ts || {
  echo "âŒ Desktop user journey tests failed!"
  echo "ğŸ’¡ Critical user journeys must pass before pushing"
  echo "ğŸš¨ User journey test failures are BLOCKING - fix before push"
  exit 1
}
cd ../..

echo ""
echo "âœ… Pre-push checks complete - ready to push!"