#!/bin/sh

# Husky pre-push hook - Performance warnings and critical tests

echo "ðŸ“¤ Pre-push validation..."

# Get the remote we're pushing to (usually origin)
REMOTE="${1:-origin}"
URL="$2"

# Check for benchmark regressions (non-blocking warning)
echo "ðŸ“Š Checking for performance regressions..."

# Run benchmark comparisons for packages with benchmarks
echo "ðŸ“ˆ Running benchmark comparisons..."

# Detect what commits we're about to push
# This gets the commits that are in HEAD but not in the remote
CURRENT_BRANCH=$(git branch --show-current)
REMOTE_REF="$REMOTE/$CURRENT_BRANCH"

# Check if remote branch exists
if git show-ref --verify --quiet "refs/remotes/$REMOTE_REF"; then
  # Remote branch exists, find changes
  CHANGED_FILES=$(git diff --name-only "$REMOTE_REF"...HEAD 2>/dev/null)
else
  # New branch, compare to main/master
  MAIN_BRANCH=$(git remote show "$REMOTE" | grep 'HEAD branch' | cut -d' ' -f5)
  MAIN_BRANCH=${MAIN_BRANCH:-main}
  CHANGED_FILES=$(git diff --name-only "$REMOTE/$MAIN_BRANCH"...HEAD 2>/dev/null)
fi

# Extract changed packages
CHANGED_PACKAGES=$(echo "$CHANGED_FILES" | grep -E "packages/.*/" | cut -d'/' -f1-3 | sort -u)

# Run benchmarks for changed packages using turbo
if [ ! -z "$CHANGED_PACKAGES" ]; then
  echo "Running benchmarks for changed packages..."
  pnpm turbo run test:benchmark --filter="...[HEAD^]" 2>&1 || true
fi

if [ ! -z "$CHANGED_PACKAGES" ]; then
  for PACKAGE in $CHANGED_PACKAGES; do
    # Check if this package has benchmark capability
    if [ -f "$PACKAGE/package.json" ]; then
      HAS_BENCHMARK=$(grep -q '"test:benchmark"' "$PACKAGE/package.json" && echo "yes" || echo "no")

      if [ "$HAS_BENCHMARK" = "yes" ] && [ -f "$PACKAGE/benchmarks/baseline.json" ] && [ -f "$PACKAGE/benchmarks/latest.json" ]; then
        echo "ðŸ“Š Comparing benchmarks for $PACKAGE..."
        tsx scripts/benchmark-compare.ts "$PACKAGE/benchmarks/baseline.json" "$PACKAGE/benchmarks/latest.json" || {
          echo "âš ï¸ Performance changes detected in $PACKAGE (non-blocking)"
          echo "ðŸ’¡ Review the comparison report before pushing"
        }
      fi
    fi
  done
fi

# Run critical E2E tests using the standardized script
# Note: test:e2e is required in packages but may echo 'No E2E tests' if not applicable
echo "ðŸŽ­ Checking critical E2E tests..."

# Check for changed files in apps/client (main E2E location)
CLIENT_CHANGED=$(echo "$CHANGED_FILES" | grep -q "apps/client" && echo "yes" || echo "no")

if [ "$CLIENT_CHANGED" = "yes" ] && [ -f "apps/client/playwright.config.ts" ]; then
  echo "Running critical user flow tests for client..."
  # Use the standard test:e2e script with critical tag filter
  # Note: Will show "No tests found" if no @critical tests exist
  timeout 120 pnpm test:e2e --grep="@critical" 2>&1 | grep -v "Error: No tests found" || {
    if [ $? -ne 0 ]; then
      echo "âš ï¸ Some E2E tests failed (non-blocking)"
      echo "ðŸ’¡ Consider fixing before push"
    fi
  }
fi

# Also check other packages for E2E tests
if [ ! -z "$CHANGED_PACKAGES" ]; then
  for PACKAGE in $CHANGED_PACKAGES; do
    if [ -f "$PACKAGE/package.json" ]; then
      HAS_E2E=$(grep -q '"test:e2e"' "$PACKAGE/package.json" && echo "yes" || echo "no")

      if [ "$HAS_E2E" = "yes" ] && [ -f "$PACKAGE/playwright.config.ts" ]; then
        echo "Running E2E tests for $PACKAGE..."
        (cd "$PACKAGE" && timeout 60 pnpm test:e2e) || {
          echo "âš ï¸ E2E tests for $PACKAGE had issues (non-blocking)"
        }
      fi
    fi
  done
fi

# Show performance dashboard summary if available
if [ -f "scripts/test-dashboard.ts" ]; then
  echo ""
  echo "ðŸ“Š Performance Summary:"
  tsx scripts/test-dashboard.ts 2>/dev/null | grep -A 5 "Alerts & Warnings" || true
fi

echo ""
echo "âœ… Pre-push checks complete - ready to push!"
echo "ðŸ’¡ Run 'pnpm test:dashboard' for detailed performance report"