/* Register custom property for smooth animation */
@property --progress-deg {
  syntax: "<angle>";
  inherits: false;
  initial-value: 0deg;
}

/**
 * Browser compatibility note for @property
 *
 * The @property CSS at-rule is not supported in Firefox as of 2025
 * Without it, custom properties like --progress-deg cannot be smoothly transitioned
 *
 * Current behavior:
 * - Chrome/Edge/Safari (Electron): Smooth circular progress animation ✅
 * - Firefox: Progress updates instantly without smooth animation
 *
 * Note: Electron desktop app uses Chromium, so full @property support is guaranteed
 *
 * Future enhancement (if web support needed):
 * - Add runtime detection using CSS.supports() or CSS.registerProperty
 * - Dynamically disable transitions for browsers without @property support
 * - See BROWSER_SUPPORT.md for implementation details
 */

:root {
  --atomiton-node-width: 80px;
  --atomiton-node-height: 80px;
  --atomiton-node-border-radius: 1.25rem;
  --atomiton-border-width: 2px; /* Controls thickness of node borders and edge paths */
  --atomiton-border-overlay-width: 2px; /* Overlay width for execution states */
  --atomiton-node-border-default: var(--color-s-01);
  --atomiton-node-border-hover: var(--color-s-02);
  --atomiton-node-border-selected: var(--color-shade-06);
  --atomiton-node-background: var(--color-surface-01);
  --atomiton-node-shadow-hover: var(--box-shadow-prompt-input);
  --atomiton-node-shadow-selected: var(--box-shadow-prompt-input);
  --atomiton-node-inner-ring-color: var(--shade-02);
  --atomiton-node-inner-ring-size: 4px;
  --atomiton-handle-size: 12px;
  --atomiton-handle-border-width: 2px;
  --atomiton-handle-border-color: var(--shade-01);
  --atomiton-handle-bg-default: var(--atomiton-node-border-default);
  --atomiton-handle-bg-hover: var(--atomiton-node-border-hover);
  --atomiton-handle-bg-selected: var(--atomiton-node-border-selected);
  --atomiton-transition-duration: 0.2s;
  --atomiton-transition-easing: ease;

  /* Execution state colors - using theme colors from @atomiton/ui */
  --atomiton-node-state-pending: var(--color-tertiary);
  --atomiton-node-state-executing: var(--color-blue);
  --atomiton-node-state-completed: var(--color-green);
  --atomiton-node-state-error: var(--color-red);
  --atomiton-node-state-skipped: var(--color-yellow);

  /* Progress animation timings */
  --atomiton-progress-transition-duration: 0.3s;
  --atomiton-progress-deg-per-percent: 3.6deg; /* 360deg / 100 for percentage conversion */

  /* Completion animation durations and effects */
  --atomiton-completion-animation-duration: 0.6s;
  --atomiton-handle-animation-duration: 0.4s;
}

/* ============================================================================
 * Keyframes for Node Completion Animations
 * ============================================================================ */

@keyframes atomiton-pulse-subtle {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.01);
  }
}

@keyframes atomiton-pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.03);
  }
}

@keyframes atomiton-pulse-strong {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.04);
  }
}

@keyframes atomiton-glow {
  0%, 100% {
    filter: drop-shadow(0 0 0px var(--atomiton-node-state-completed));
  }
  50% {
    filter: drop-shadow(0 0 8px var(--atomiton-node-state-completed));
  }
}

@keyframes atomiton-bounce {
  0%, 100% {
    transform: translateY(0);
  }
  25% {
    transform: translateY(-8px);
  }
  50% {
    transform: translateY(0);
  }
  75% {
    transform: translateY(-4px);
  }
}

@keyframes atomiton-ripple {
  0% {
    box-shadow: 0 0 0 0 var(--atomiton-node-state-completed);
    opacity: 1;
  }
  100% {
    box-shadow: 0 0 0 20px var(--atomiton-node-state-completed);
    opacity: 0;
  }
}

/* ============================================================================
 * Keyframes for Handle Connection Animations
 * ============================================================================ */

@keyframes atomiton-handle-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 transparent;
  }
  50% {
    box-shadow: 0 0 0 4px currentColor;
    opacity: 0.3;
  }
}

@keyframes atomiton-handle-ping {
  0% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  75%, 100% {
    transform: translate(-50%, -50%) scale(2);
    opacity: 0;
  }
}

@keyframes atomiton-handle-ripple {
  0% {
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 0 0 0 0 var(--atomiton-node-state-executing);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1.5);
    box-shadow: 0 0 0 6px var(--atomiton-node-state-executing);
    opacity: 0;
  }
}

:is(
  .react-flow__node,
  .react-flow__node-input,
  .react-flow__node-default,
  .react-flow__node-output,
  .react-flow__node-group
) {
  box-sizing: border-box;
  width: var(--atomiton-node-width);
  height: var(--atomiton-node-height);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  border-radius: var(--atomiton-node-border-radius);
  background-color: var(--atomiton-node-background);
  cursor: pointer;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )
  .atomiton-node {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  border-radius: var(--atomiton-node-border-radius);
  transition: box-shadow var(--atomiton-transition-duration)
    var(--atomiton-transition-easing);
}

/* ::before pseudo element - always-visible gray border (base layer, like edge background path) */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )
  .atomiton-node::before {
  content: "";
  position: absolute;
  inset: calc(-1 * var(--atomiton-border-width));
  border-radius: inherit;
  border: var(--atomiton-border-width) solid var(--atomiton-node-border-default);
  pointer-events: none;
  transition: border-color var(--atomiton-transition-duration)
    var(--atomiton-transition-easing);
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:hover {
  border-color: var(--atomiton-node-border-hover);
  box-shadow: none;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:hover
  .atomiton-node {
  box-shadow: 0 0 0 var(--atomiton-node-inner-ring-size)
    var(--atomiton-node-inner-ring-color) inset;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:is(.selected, :focus, :focus-visible) {
  border-color: var(--atomiton-node-border-selected);
  box-shadow: var(--atomiton-node-shadow-selected);
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:is(.selected, :focus, :focus-visible)
  .atomiton-node {
  box-shadow: 0 0 0 var(--atomiton-node-inner-ring-size)
    var(--atomiton-node-inner-ring-color) inset;
}

/* Change ::before border color when selected to match handles */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:is(.selected, :focus, :focus-visible)
  .atomiton-node::before {
  border-color: var(--atomiton-node-border-selected);
}

.react-flow__handle {
  z-index: 1; /* Above ::after overlay */
  width: var(--atomiton-handle-size);
  height: var(--atomiton-handle-size);
  border: var(--atomiton-handle-border-width) solid
    var(--atomiton-handle-border-color);
  background-color: var(--atomiton-handle-bg-default);
  border-radius: 50%;
  transition: background-color var(--atomiton-transition-duration)
    var(--atomiton-transition-easing);
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:hover
  .react-flow__handle {
  background-color: var(--atomiton-handle-bg-hover);
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  ).selectable:is(.selected, :focus, :focus-visible)
  .react-flow__handle {
  background-color: var(--atomiton-handle-bg-selected);
}

/* ::after pseudo element - colored progress overlay (only for executing/error states) */

/* Executing state - dual progress borders from left input to right output handle */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="executing"]
  .atomiton-node::after {
  --progress-deg: calc(var(--progress, 0) * var(--atomiton-progress-deg-per-percent));
  content: "";
  position: absolute;
  z-index: 0; /* Below handles (z-index: 1) */
  inset: calc(-1 * var(--atomiton-border-overlay-width));
  border-radius: inherit;
  padding: var(--atomiton-border-overlay-width);
  /* Two paths from left (input) to right (output):
     - Bottom path: left → down → right (clockwise)
     - Top path: left → up → right (counter-clockwise) */
  background:
    conic-gradient(
      from 270deg,
      var(--atomiton-node-state-executing) 0deg,
      var(--atomiton-node-state-executing) calc(var(--progress-deg) / 2),
      transparent calc(var(--progress-deg) / 2)
    ),
    conic-gradient(
      from 270deg,
      transparent 0deg,
      transparent calc(360deg - var(--progress-deg) / 2),
      var(--atomiton-node-state-executing) calc(360deg - var(--progress-deg) / 2)
    );
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  mask-composite: exclude;
  pointer-events: none;
  transition: --progress-deg var(--atomiton-progress-transition-duration) ease-out;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="executing"]
  .react-flow__handle {
  background-color: var(--atomiton-node-state-executing);
}

/* Completed state - dual green borders from left input to right output handle */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"]
  .atomiton-node::after {
  --progress-deg: 360deg; /* Full progress - both borders meet at output handle */
  content: "";
  position: absolute;
  z-index: 0; /* Below handles (z-index: 1) */
  inset: calc(-1 * var(--atomiton-border-overlay-width));
  border-radius: inherit;
  padding: var(--atomiton-border-overlay-width);
  /* Two paths from left (input) to right (output):
     - Bottom path: left → down → right (clockwise)
     - Top path: left → up → right (counter-clockwise) */
  background:
    conic-gradient(
      from 270deg,
      var(--atomiton-node-state-completed) 0deg,
      var(--atomiton-node-state-completed) calc(var(--progress-deg) / 2),
      transparent calc(var(--progress-deg) / 2)
    ),
    conic-gradient(
      from 270deg,
      transparent 0deg,
      transparent calc(360deg - var(--progress-deg) / 2),
      var(--atomiton-node-state-completed) calc(360deg - var(--progress-deg) / 2)
    );
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  mask-composite: exclude;
  pointer-events: none;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"]
  .react-flow__handle {
  background-color: var(--atomiton-node-state-completed);
}

/* ============================================================================
 * Node Completion Animations - Applied when node completes
 * ============================================================================ */

/* Pulse animation - subtle variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="pulse-subtle"]
  .atomiton-node {
  animation: atomiton-pulse-subtle 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Pulse animation - normal variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="pulse"]
  .atomiton-node {
  animation: atomiton-pulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Pulse animation - strong variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="pulse-strong"]
  .atomiton-node {
  animation: atomiton-pulse-strong 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Glow animation - subtle drop shadow pulse */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="glow"]
  .atomiton-node {
  animation: atomiton-glow var(--atomiton-completion-animation-duration) ease-out;
}

/* Bounce animation - subtle vertical bounce */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="bounce"]
  .atomiton-node {
  animation: atomiton-bounce var(--atomiton-completion-animation-duration) ease-out;
}

/* Ripple animation - expanding box shadow */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="completed"][data-completion-animation="ripple"]
  .atomiton-node::before {
  animation: atomiton-ripple var(--atomiton-completion-animation-duration) ease-out;
}

/* ============================================================================
 * Handle Connection Animations - Applied when edge connects
 * ============================================================================ */

/* Pulse animation for handles */
.react-flow__handle[data-handle-animation="pulse"] {
  animation: atomiton-handle-pulse var(--atomiton-handle-animation-duration) ease-out;
}

/* Ping animation for handles - expanding circle */
.react-flow__handle[data-handle-animation="ping"] {
  position: relative;
}

.react-flow__handle[data-handle-animation="ping"]::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: currentColor;
  animation: atomiton-handle-ping var(--atomiton-handle-animation-duration) ease-out;
  pointer-events: none;
}

/* Ripple animation for handles */
.react-flow__handle[data-handle-animation="ripple"] {
  position: relative;
}

.react-flow__handle[data-handle-animation="ripple"]::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  border-radius: 50%;
  animation: atomiton-handle-ripple var(--atomiton-handle-animation-duration) ease-out;
  pointer-events: none;
}

/* Error state - red conic gradient overlay */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"]
  .atomiton-node::after {
  content: "";
  position: absolute;
  z-index: 0; /* Below handles (z-index: 1) */
  inset: calc(-1 * var(--atomiton-border-overlay-width));
  border-radius: inherit;
  padding: var(--atomiton-border-overlay-width);
  /* Error state shows full red border, ignoring progress value */
  background: var(--atomiton-node-state-error);
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  mask-composite: exclude;
  pointer-events: none;
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"]
  .react-flow__handle {
  background-color: var(--atomiton-node-state-error);
}

/* ============================================================================
 * Node Error Animations - Applied when node errors
 * ============================================================================ */

/* Shake animations for errors */
@keyframes atomiton-shake-subtle {
  0%, 100% {
    transform: translateX(0);
  }
  20%, 60% {
    transform: translateX(-0.5px);
  }
  40% {
    transform: translateX(0.5px);
  }
}

@keyframes atomiton-shake {
  0%, 100% {
    transform: translateX(0);
  }
  20%, 60% {
    transform: translateX(-1px);
  }
  40% {
    transform: translateX(1px);
  }
}

@keyframes atomiton-shake-strong {
  0%, 100% {
    transform: translateX(0);
  }
  20%, 60% {
    transform: translateX(-2px);
  }
  40% {
    transform: translateX(2px);
  }
}

/* Pulse error animation - subtle variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"][data-error-animation="pulse-subtle"]
  .atomiton-node {
  animation: atomiton-pulse-subtle 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Pulse error animation - normal variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"][data-error-animation="pulse"]
  .atomiton-node {
  animation: atomiton-pulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Pulse error animation - strong variant */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"][data-error-animation="pulse-strong"]
  .atomiton-node {
  animation: atomiton-pulse-strong 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Glow error animation */
:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="error"][data-error-animation="glow"]
  .atomiton-node {
  animation: atomiton-glow var(--atomiton-completion-animation-duration) ease-out;
  filter: drop-shadow(0 0 8px var(--atomiton-node-state-error));
}

:is(
  .react-flow__node,
  .react-flow__node-input,
  .react-flow__node-default,
  .react-flow__node-output,
  .react-flow__node-group
)[data-execution-state="skipped"] {
  border-color: var(--atomiton-node-state-skipped);
}

:is(
    .react-flow__node,
    .react-flow__node-input,
    .react-flow__node-default,
    .react-flow__node-output,
    .react-flow__node-group
  )[data-execution-state="skipped"]
  .react-flow__handle {
  background-color: var(--atomiton-node-state-skipped);
}

/* No border color transitions - border stays default gray, only overlay changes */

/* ============================================================================
 * Edge Progress Animations
 * ============================================================================
 * Dual-path approach for linear determinate progress bars:
 * 1. Background path (gray) - always visible
 * 2. Foreground path (green/red) - uses dasharray to progressively reveal
 */

/* Background path - always visible in gray, matches node border */
.react-flow__edge-path-bg {
  stroke: var(--atomiton-node-border-default);
  stroke-width: var(--atomiton-border-width);
}

/* Override default edge path stroke color */
.react-flow__edge-path {
  stroke: var(--atomiton-node-border-default);
}

/* Foreground path states - only show colored overlay for executing/error */
.react-flow__edge[data-edge-state="inactive"] .react-flow__edge-path,
.react-flow__edge[data-edge-state="pending"] .react-flow__edge-path {
  stroke: none; /* Hide foreground, show only gray background */
}

/* Executing state - blue progress overlay */
.react-flow__edge[data-edge-state="executing"] .react-flow__edge-path {
  stroke: var(--atomiton-node-state-executing); /* Blue while executing */
  stroke-width: var(--atomiton-border-overlay-width);
  /* dasharray and dashoffset set dynamically in JS for progress effect */
  transition:
    stroke var(--atomiton-progress-transition-duration) ease,
    stroke-dashoffset var(--atomiton-progress-transition-duration) ease;
  will-change: stroke-dashoffset; /* GPU acceleration hint */
}

/* Completed state - green progress overlay */
.react-flow__edge[data-edge-state="completed"] .react-flow__edge-path {
  stroke: var(--atomiton-node-state-completed); /* Green when complete */
  stroke-width: var(--atomiton-border-overlay-width);
  /* dasharray and dashoffset set dynamically in JS for progress effect */
  transition:
    stroke var(--atomiton-progress-transition-duration) ease,
    stroke-dashoffset var(--atomiton-progress-transition-duration) ease;
  will-change: stroke-dashoffset; /* GPU acceleration hint */
}

/* Error state - red when connected to error nodes */
.react-flow__edge[data-edge-state="error"] .react-flow__edge-path {
  stroke: var(--atomiton-node-state-error); /* Red for errors */
  stroke-width: var(--atomiton-border-overlay-width);
  /* dasharray and dashoffset set dynamically in JS for progress effect */
  transition: stroke var(--atomiton-progress-transition-duration) ease;
}
