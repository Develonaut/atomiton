# Lefthook configuration for Atomiton monorepo
# https://github.com/evilmartians/lefthook

# Set environment variable to indicate running in git hooks (affects headless mode, dev tools, etc.)
env:
  LEFTHOOK: "1"

# Fast pre-commit hooks - catches 95% of issues in ~15-30s
pre-commit:
  parallel: true
  commands:
    # Format staged files with Prettier
    format:
      glob: "*.{ts,tsx,js,jsx,md,json,yml,yaml}"
      run: pnpm prettier --write {staged_files}
      stage_fixed: true
      fail_text: "❌ Formatting failed"

    # Fix linting issues on staged TypeScript/JavaScript files
    lint-fix:
      glob: "*.{ts,tsx,js,jsx}"
      run: pnpm eslint --fix {staged_files}
      stage_fixed: true
      fail_text: "❌ Linting fixes failed"

    # Format markdown tables in staged markdown files
    markdown-tables:
      glob: "*.md"
      run: npx markdown-table-prettify {staged_files}
      stage_fixed: true
      fail_text: "❌ Markdown table formatting failed"

    # Auto-regenerate preload types when RPC types change
    preload-types:
      glob: "packages/@atomiton/rpc/src/shared/types.ts"
      run: |
        echo "🔄 RPC types changed, regenerating preload types..."
        pnpm generate:preload-types

        echo "✅ Validating preload types..."
        pnpm validate:preload-types

        # Stage regenerated file if changed
        git add apps/desktop/src/preload/preload.d.ts
      fail_text: "❌ Preload type generation failed"

    # Type check all packages (turbo cached, very fast)
    type-check:
      run: |
        echo "🔍 Type checking affected packages..."
        pnpm typecheck
      fail_text: "❌ Type check failed - please fix TypeScript errors"

    # Unit tests (turbo cached, catches logic errors early)
    unit-tests:
      run: |
        echo "🧪 Running tests in affected packages..."
        pnpm test
      fail_text: "❌ Unit tests failed - please fix failing tests"

# Comprehensive pre-push hooks - runs ~2-5min before sharing code
pre-push:
  parallel: true
  commands:
    build-check:
      run: |
        echo "🏗️ Verifying build integrity for affected packages..."
        pnpm build
      fail_text: "❌ Build failed - please fix build errors"

    # Integration tests (tests package interactions)
    integration-tests:
      run: |
        echo "🎭 Running integration tests in affected packages..."
        pnpm test:integration
      fail_text: "❌ Integration tests failed"

    # E2E tests (tests full user flows, headless by default)
    e2e-tests:
      run: |
        echo "🌐 Running end-to-end tests (headless) in affected packages..."
        pnpm test:e2e
      fail_text: "❌ E2E tests failed"

# Skip options for cleaner output
skip_output:
  - meta
  - summary
